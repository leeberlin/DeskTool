<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="DeskTool.Views.ImageOcrPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:vm="using:DeskTool.ViewModels"
    mc:Ignorable="d"
    AllowDrop="True"
    DragOver="Page_DragOver"
    Drop="Page_Drop">

    <Grid Padding="0">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" MinWidth="300"/>
            <ColumnDefinition Width="Auto"/>
            <ColumnDefinition Width="400" MinWidth="300"/>
        </Grid.ColumnDefinitions>

        <!-- Left Panel: Image Preview -->
        <Grid Grid.Column="0">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- Toolbar -->
            <StackPanel Grid.Row="0" Style="{StaticResource ToolbarStyle}">
                <Button Command="{x:Bind ViewModel.OpenFileCommand}" ToolTipService.ToolTip="Open Image (Ctrl+O)">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE8E5;" FontSize="16"/>
                        <TextBlock Text="Open"/>
                    </StackPanel>
                </Button>
                
                <AppBarSeparator/>
                
                <Button Command="{x:Bind ViewModel.Rotate90Command}" Style="{StaticResource IconButtonStyle}" 
                        ToolTipService.ToolTip="Rotate 90°">
                    <FontIcon Glyph="&#xE7AD;" FontSize="16"/>
                </Button>
                <Button Command="{x:Bind ViewModel.Rotate180Command}" Style="{StaticResource IconButtonStyle}"
                        ToolTipService.ToolTip="Rotate 180°">
                    <FontIcon Glyph="&#xE7AD;" FontSize="16"/>
                </Button>
                <Button Command="{x:Bind ViewModel.ClearCropCommand}" Style="{StaticResource IconButtonStyle}"
                        ToolTipService.ToolTip="Clear Crop">
                    <FontIcon Glyph="&#xE71A;" FontSize="16"/>
                </Button>
            </StackPanel>

            <!-- Image Preview Area -->
            <Border Grid.Row="1" Style="{StaticResource DropZoneStyle}" Margin="16,8,8,8">
                <Grid>
                    <!-- Drop hint when no image -->
                    <StackPanel Visibility="{x:Bind ViewModel.HasImage, Converter={StaticResource BoolToVisibilityInverter}, Mode=OneWay}"
                                HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="16">
                        <FontIcon Glyph="&#xE8B9;" FontSize="64" 
                                  Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                        <TextBlock Text="Drop image here or click Open" 
                                   Style="{StaticResource SubtitleTextBlockStyle}"
                                   Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                        <TextBlock Text="Supports: PNG, JPG, WEBP, TIFF"
                                   Style="{StaticResource CaptionTextBlockStyle}"
                                   Foreground="{ThemeResource TextFillColorTertiaryBrush}"/>
                    </StackPanel>

                    <!-- Image with zoom scroll viewer -->
                    <ScrollViewer x:Name="ImageScrollViewer"
                                  ZoomMode="Enabled"
                                  MinZoomFactor="0.1"
                                  MaxZoomFactor="5"
                                  HorizontalScrollBarVisibility="Auto"
                                  VerticalScrollBarVisibility="Auto"
                                  Visibility="{x:Bind ViewModel.HasImage, Mode=OneWay}">
                        <Grid>
                            <Image x:Name="PreviewImage"
                                   Source="{x:Bind ViewModel.PreviewImage, Mode=OneWay}"
                                   Stretch="Uniform"/>
                            
                            <!-- Crop overlay would go here -->
                            <Canvas x:Name="CropCanvas" 
                                    PointerPressed="CropCanvas_PointerPressed"
                                    PointerMoved="CropCanvas_PointerMoved"
                                    PointerReleased="CropCanvas_PointerReleased"/>
                        </Grid>
                    </ScrollViewer>
                </Grid>
            </Border>

            <!-- Preprocessing Options -->
            <Border Grid.Row="2" Padding="16,8" Background="{ThemeResource LayerOnMicaBaseAltFillColorDefaultBrush}">
                <StackPanel Orientation="Horizontal" Spacing="24">
                    <CheckBox Content="Grayscale" IsChecked="{x:Bind ViewModel.UseGrayscale, Mode=TwoWay}"/>
                    <CheckBox Content="Threshold" IsChecked="{x:Bind ViewModel.UseThreshold, Mode=TwoWay}"/>
                    <Slider x:Name="ThresholdSlider" 
                            Width="120" 
                            Minimum="0" Maximum="255" 
                            Value="{x:Bind ViewModel.ThresholdValue, Mode=TwoWay}"
                            IsEnabled="{x:Bind ViewModel.UseThreshold, Mode=OneWay}"
                            ToolTipService.ToolTip="Threshold value"/>
                    <TextBlock Text="{x:Bind ViewModel.RotationDegrees, Mode=OneWay}" 
                               VerticalAlignment="Center"
                               Margin="16,0,0,0"/>
                    <TextBlock Text="°" VerticalAlignment="Center"/>
                </StackPanel>
            </Border>
        </Grid>

        <!-- Splitter -->
        <GridSplitter Grid.Column="1" Width="8" 
                      Background="Transparent"
                      ResizeBehavior="BasedOnAlignment"/>

        <!-- Right Panel: OCR Controls & Results -->
        <Grid Grid.Column="2">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- Language Selection -->
            <Border Grid.Row="0" Style="{StaticResource CardStyle}" Margin="8,16,16,8">
                <StackPanel Spacing="8">
                    <TextBlock Text="OCR Languages" Style="{StaticResource SubtitleTextBlockStyle}"/>
                    <StackPanel Orientation="Horizontal" Spacing="16">
                        <CheckBox Content="English" IsChecked="{x:Bind ViewModel.UseEnglish, Mode=TwoWay}"/>
                        <CheckBox Content="Vietnamese" IsChecked="{x:Bind ViewModel.UseVietnamese, Mode=TwoWay}"/>
                        <CheckBox Content="German" IsChecked="{x:Bind ViewModel.UseGerman, Mode=TwoWay}"/>
                    </StackPanel>
                </StackPanel>
            </Border>

            <!-- OCR Button & Progress -->
            <StackPanel Grid.Row="1" Spacing="12" Margin="8,8,16,8">
                <Grid>
                    <Button x:Name="OcrButton"
                            Command="{x:Bind ViewModel.RunOcrCommand}"
                            Style="{StaticResource ActionButtonStyle}"
                            HorizontalAlignment="Stretch"
                            Visibility="{x:Bind ViewModel.IsProcessing, Converter={StaticResource BoolToVisibilityInverter}, Mode=OneWay}">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE8F4;" FontSize="16"/>
                            <TextBlock Text="Run OCR"/>
                        </StackPanel>
                    </Button>
                    
                    <Button Command="{x:Bind ViewModel.CancelOcrCommand}"
                            Style="{StaticResource ActionButtonStyle}"
                            Background="{StaticResource ErrorBrush}"
                            HorizontalAlignment="Stretch"
                            Visibility="{x:Bind ViewModel.IsProcessing, Mode=OneWay}">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE711;" FontSize="16"/>
                            <TextBlock Text="Cancel"/>
                        </StackPanel>
                    </Button>
                </Grid>

                <ProgressBar Value="{x:Bind ViewModel.Progress, Mode=OneWay}"
                             Maximum="100"
                             Visibility="{x:Bind ViewModel.IsProcessing, Mode=OneWay}"/>
            </StackPanel>

            <!-- Results -->
            <Border Grid.Row="2" Style="{StaticResource CardStyle}" Margin="8,8,16,8">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="16" Margin="0,0,0,8">
                        <TextBlock Text="Result" Style="{StaticResource SubtitleTextBlockStyle}"/>
                        <TextBlock Text="{x:Bind ViewModel.Confidence, Mode=OneWay, Converter={StaticResource ConfidenceFormatter}}"
                                   Style="{StaticResource StatusTextStyle}"
                                   VerticalAlignment="Center"/>
                    </StackPanel>

                    <TextBox Grid.Row="1"
                             x:Name="ResultTextBox"
                             Text="{x:Bind ViewModel.ResultText, Mode=TwoWay}"
                             Style="{StaticResource ResultTextBoxStyle}"
                             PlaceholderText="OCR results will appear here..."
                             ScrollViewer.VerticalScrollBarVisibility="Auto"/>
                </Grid>
            </Border>

            <!-- Action Buttons & Status -->
            <Grid Grid.Row="3" Padding="8,8,16,16">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <TextBlock Grid.Column="0" 
                           Text="{x:Bind ViewModel.StatusMessage, Mode=OneWay}"
                           Style="{StaticResource StatusTextStyle}"
                           VerticalAlignment="Center"
                           TextTrimming="CharacterEllipsis"/>

                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                    <Button Command="{x:Bind ViewModel.CopyResultCommand}" 
                            Style="{StaticResource IconButtonStyle}"
                            ToolTipService.ToolTip="Copy (Ctrl+C)">
                        <FontIcon Glyph="&#xE8C8;" FontSize="16"/>
                    </Button>
                    <Button Command="{x:Bind ViewModel.SaveAsTextCommand}"
                            Style="{StaticResource IconButtonStyle}"
                            ToolTipService.ToolTip="Save as .txt">
                        <FontIcon Glyph="&#xE74E;" FontSize="16"/>
                    </Button>
                    <Button Command="{x:Bind ViewModel.SaveAsDocxCommand}"
                            Style="{StaticResource IconButtonStyle}"
                            ToolTipService.ToolTip="Save as .docx">
                        <FontIcon Glyph="&#xE8A5;" FontSize="16"/>
                    </Button>
                </StackPanel>
            </Grid>
        </Grid>
    </Grid>
</Page>
