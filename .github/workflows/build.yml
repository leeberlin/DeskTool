name: Build DeskTool

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '8.0.x'
  SOLUTION_PATH: 'DeskTool.sln'

jobs:
  build:
    runs-on: windows-latest
    
    strategy:
      matrix:
        platform: [x64]
        configuration: [Release]

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Install .NET MAUI/WinUI Workloads
      run: |
        dotnet workload install maui-windows --skip-manifest-update
        dotnet workload install wasm-tools --skip-manifest-update
      shell: pwsh
      continue-on-error: true

    - name: Download Tesseract Language Data
      run: |
        mkdir -p tessdata
        Invoke-WebRequest -Uri "https://github.com/tesseract-ocr/tessdata/raw/main/eng.traineddata" -OutFile "tessdata/eng.traineddata"
        Invoke-WebRequest -Uri "https://github.com/tesseract-ocr/tessdata/raw/main/vie.traineddata" -OutFile "tessdata/vie.traineddata"
        Invoke-WebRequest -Uri "https://github.com/tesseract-ocr/tessdata/raw/main/deu.traineddata" -OutFile "tessdata/deu.traineddata"
      shell: pwsh

    - name: Restore dependencies
      run: dotnet restore ${{ env.SOLUTION_PATH }} -p:Platform=${{ matrix.platform }}

    - name: Build
      run: |
        dotnet build ${{ env.SOLUTION_PATH }} `
          --configuration ${{ matrix.configuration }} `
          --no-restore `
          -p:Platform=${{ matrix.platform }} `
          -p:GenerateAppxPackageOnBuild=false `
          -v:m
      shell: pwsh

    - name: Test
      run: |
        dotnet test src/DeskTool.Tests/DeskTool.Tests.csproj `
          --configuration ${{ matrix.configuration }} `
          --no-build `
          --verbosity normal `
          -p:Platform=${{ matrix.platform }}
      shell: pwsh

    - name: Publish
      run: |
        dotnet publish src/DeskTool/DeskTool.csproj `
          --configuration ${{ matrix.configuration }} `
          --runtime win-${{ matrix.platform }} `
          --self-contained true `
          --output ./publish `
          -p:PublishReadyToRun=true `
          -p:WindowsAppSDKSelfContained=true
      shell: pwsh

    - name: Copy tessdata to publish
      run: |
        Copy-Item -Path "tessdata" -Destination "./publish/tessdata" -Recurse
      shell: pwsh

    - name: Upload Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: DeskTool-${{ matrix.platform }}-${{ matrix.configuration }}
        path: ./publish/
        retention-days: 30

  create-installer:
    needs: build
    runs-on: windows-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Download Build Artifact
      uses: actions/download-artifact@v4
      with:
        name: DeskTool-x64-Release
        path: ./publish

    - name: Create ZIP Package
      run: |
        Compress-Archive -Path ./publish/* -DestinationPath ./DeskTool_x64.zip
      shell: pwsh

    - name: Upload Installer
      uses: actions/upload-artifact@v4
      with:
        name: DeskTool-Installer
        path: ./DeskTool_x64.zip
        retention-days: 90
